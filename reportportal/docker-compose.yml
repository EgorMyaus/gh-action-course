# =============================================================================
# ReportPortal - Self-Hosted Test Reporting Platform
# =============================================================================
# DevOps Learning Stack:
#   - PostgreSQL (Database)
#   - MinIO (S3-compatible Object Storage)
#   - RabbitMQ (Message Queue)
#   - Elasticsearch (Search & Analytics) - OpenSearch
#   - Traefik (Reverse Proxy & Load Balancer)
#   - ReportPortal Services (API, UI, Analyzer, etc.)
# =============================================================================
# Usage:
#   docker-compose up -d
#   Access: http://localhost:8080
#   Default: superadmin / erebus
# =============================================================================

version: '3.8'

services:
  # ===========================================================================
  # TRAEFIK - Reverse Proxy & Load Balancer
  # ===========================================================================
  traefik:
    image: traefik:v2.10
    container_name: reportportal-traefik
    command:
      - "--api.insecure=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:8080"
      - "--entrypoints.traefik.address=:8081"
    ports:
      - "8080:8080"   # ReportPortal UI
      - "8081:8081"   # Traefik Dashboard
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - reportportal
    restart: unless-stopped

  # ===========================================================================
  # POSTGRESQL - Primary Database
  # ===========================================================================
  postgres:
    image: postgres:14-alpine
    container_name: reportportal-postgres
    environment:
      POSTGRES_USER: rpuser
      POSTGRES_PASSWORD: rppass
      POSTGRES_DB: reportportal
    volumes:
      - postgres-data:/var/lib/postgresql/data
    networks:
      - reportportal
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U rpuser -d reportportal"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # ===========================================================================
  # MINIO - S3-Compatible Object Storage (for attachments)
  # ===========================================================================
  minio:
    image: minio/minio:RELEASE.2023-10-07T15-07-38Z
    container_name: reportportal-minio
    environment:
      MINIO_ROOT_USER: minio
      MINIO_ROOT_PASSWORD: minio123
    volumes:
      - minio-data:/data
    command: server /data --console-address ":9001"
    ports:
      - "9000:9000"   # MinIO API
      - "9001:9001"   # MinIO Console
    networks:
      - reportportal
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3
    restart: unless-stopped

  # ===========================================================================
  # RABBITMQ - Message Queue
  # ===========================================================================
  rabbitmq:
    image: rabbitmq:3.12-management-alpine
    container_name: reportportal-rabbitmq
    environment:
      RABBITMQ_DEFAULT_USER: rabbitmq
      RABBITMQ_DEFAULT_PASS: rabbitmq
    volumes:
      - rabbitmq-data:/var/lib/rabbitmq
    ports:
      - "5672:5672"   # AMQP
      - "15672:15672" # Management UI
    networks:
      - reportportal
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "check_running"]
      interval: 30s
      timeout: 10s
      retries: 5
    restart: unless-stopped

  # ===========================================================================
  # OPENSEARCH - Search & Analytics (Elasticsearch alternative)
  # ===========================================================================
  opensearch:
    image: opensearchproject/opensearch:2.11.0
    container_name: reportportal-opensearch
    environment:
      - discovery.type=single-node
      - plugins.security.disabled=true
      - bootstrap.memory_lock=true
      - "OPENSEARCH_JAVA_OPTS=-Xms512m -Xmx512m"
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 65536
        hard: 65536
    volumes:
      - opensearch-data:/usr/share/opensearch/data
    networks:
      - reportportal
    healthcheck:
      test: ["CMD-SHELL", "curl -s http://localhost:9200/_cluster/health | grep -q '\"status\":\"green\"\\|\"status\":\"yellow\"'"]
      interval: 30s
      timeout: 10s
      retries: 5
    restart: unless-stopped

  # ===========================================================================
  # REPORTPORTAL - API Service
  # ===========================================================================
  api:
    image: reportportal/service-api:5.10.0
    container_name: reportportal-api
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      minio:
        condition: service_healthy
    environment:
      RP_DB_HOST: postgres
      RP_DB_PORT: 5432
      RP_DB_USER: rpuser
      RP_DB_PASS: rppass
      RP_DB_NAME: reportportal
      RP_AMQP_HOST: rabbitmq
      RP_AMQP_PORT: 5672
      RP_AMQP_USER: rabbitmq
      RP_AMQP_PASS: rabbitmq
      RP_BINARYSTORE_TYPE: minio
      RP_BINARYSTORE_MINIO_ENDPOINT: http://minio:9000
      RP_BINARYSTORE_MINIO_ACCESSKEY: minio
      RP_BINARYSTORE_MINIO_SECRETKEY: minio123
      LOGGING_LEVEL_ORG_HIBERNATE_SQL: info
      JAVA_OPTS: "-Xmx1g -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=/tmp"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.api.rule=PathPrefix(`/api`) || PathPrefix(`/composite`)"
      - "traefik.http.routers.api.entrypoints=web"
      - "traefik.http.services.api.loadbalancer.server.port=8585"
    networks:
      - reportportal
    restart: unless-stopped

  # ===========================================================================
  # REPORTPORTAL - Authorization Service
  # ===========================================================================
  uat:
    image: reportportal/service-authorization:5.10.0
    container_name: reportportal-uat
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      RP_DB_HOST: postgres
      RP_DB_PORT: 5432
      RP_DB_USER: rpuser
      RP_DB_PASS: rppass
      RP_DB_NAME: reportportal
      RP_SESSION_LIVE: 86400
      RP_SAML_SESSION-LIVE: 4320
      JAVA_OPTS: "-Xmx512m -XX:+HeapDumpOnOutOfMemoryError"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.uat.rule=PathPrefix(`/uat`)"
      - "traefik.http.routers.uat.entrypoints=web"
      - "traefik.http.services.uat.loadbalancer.server.port=9999"
    networks:
      - reportportal
    restart: unless-stopped

  # ===========================================================================
  # REPORTPORTAL - UI Service
  # ===========================================================================
  ui:
    image: reportportal/service-ui:5.10.0
    container_name: reportportal-ui
    environment:
      RP_SERVER_PORT: 8080
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.ui.rule=PathPrefix(`/`)"
      - "traefik.http.routers.ui.entrypoints=web"
      - "traefik.http.routers.ui.priority=1"
      - "traefik.http.services.ui.loadbalancer.server.port=8080"
    networks:
      - reportportal
    restart: unless-stopped

  # ===========================================================================
  # REPORTPORTAL - Index Service (Optional - for search)
  # ===========================================================================
  index:
    image: reportportal/service-index:5.10.0
    container_name: reportportal-index
    depends_on:
      - opensearch
    environment:
      LB_URL: http://traefik:8081
      TRAEFIK_V2: "true"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.index.rule=PathPrefix(`/`)"
      - "traefik.http.routers.index.entrypoints=web"
      - "traefik.http.routers.index.priority=0"
      - "traefik.http.services.index.loadbalancer.server.port=8080"
    networks:
      - reportportal
    restart: unless-stopped

  # ===========================================================================
  # REPORTPORTAL - Analyzer Service (AI-based failure analysis)
  # ===========================================================================
  analyzer:
    image: reportportal/service-auto-analyzer:5.10.0
    container_name: reportportal-analyzer
    depends_on:
      - opensearch
      - rabbitmq
    environment:
      LOGGING_LEVEL: info
      AMQP_URL: amqp://rabbitmq:rabbitmq@rabbitmq:5672
      ES_HOSTS: http://opensearch:9200
      MINIO_SHORT_HOST: minio:9000
      MINIO_ACCESS_KEY: minio
      MINIO_SECRET_KEY: minio123
    networks:
      - reportportal
    restart: unless-stopped

  # ===========================================================================
  # REPORTPORTAL - Migrations Service (runs once)
  # ===========================================================================
  migrations:
    image: reportportal/migrations:5.10.0
    container_name: reportportal-migrations
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      POSTGRES_SERVER: postgres
      POSTGRES_PORT: 5432
      POSTGRES_DB: reportportal
      POSTGRES_USER: rpuser
      POSTGRES_PASSWORD: rppass
    networks:
      - reportportal
    restart: "no"

# =============================================================================
# NETWORKS
# =============================================================================
networks:
  reportportal:
    driver: bridge

# =============================================================================
# VOLUMES (Persistent Data)
# =============================================================================
volumes:
  postgres-data:
    name: reportportal-postgres-data
  minio-data:
    name: reportportal-minio-data
  rabbitmq-data:
    name: reportportal-rabbitmq-data
  opensearch-data:
    name: reportportal-opensearch-data
